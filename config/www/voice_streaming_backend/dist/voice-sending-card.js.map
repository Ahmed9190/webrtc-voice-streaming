{"version":3,"file":"voice-sending-card.js","sources":["../../frontend/src/voice-sending-editor.ts","../../frontend/src/voice-sending-card.ts"],"sourcesContent":["import { LitElement, html, css, TemplateResult } from \"lit\";\nimport { customElement, property, state } from \"lit/decorators.js\";\nimport { HomeAssistant, VoiceStreamingCardConfig } from \"./types\";\n\n@customElement(\"voice-sending-card-editor\")\nexport class VoiceSendingCardEditor extends LitElement {\n  @property({ attribute: false }) public hass!: HomeAssistant;\n  @state() private _config!: VoiceStreamingCardConfig;\n\n  public setConfig(config: VoiceStreamingCardConfig): void {\n    this._config = config;\n  }\n\n  private _valueChanged(ev: CustomEvent): void {\n    if (!this._config || !this.hass) {\n      return;\n    }\n    const target = ev.target as any;\n    if ((this as any)[`_${target.configValue}`] === target.value) {\n      return;\n    }\n    if (target.configValue) {\n      if (target.value === \"\") {\n        const newConfig = { ...this._config };\n        delete newConfig[target.configValue!];\n        this._config = newConfig;\n      } else {\n        this._config = {\n          ...this._config,\n          [target.configValue!]: target.checked !== undefined ? target.checked : target.value,\n        };\n      }\n    }\n    this.dispatchEvent(new CustomEvent(\"config-changed\", { detail: { config: this._config }, bubbles: true, composed: true }));\n  }\n\n  protected render(): TemplateResult {\n    if (!this.hass || !this._config) {\n      return html``;\n    }\n\n    return html`\n      <div class=\"card-config\">\n        <ha-textfield label=\"Title\" .value=${this._config.title || \"\"} .configValue=${\"title\"} @input=${this._valueChanged}></ha-textfield>\n        <ha-textfield\n          label=\"Server URL (optional)\"\n          .value=${this._config.server_url || \"\"}\n          .configValue=${\"server_url\"}\n          helper=\"Defaults to localhost:8080/ws\"\n          @input=${this._valueChanged}\n        ></ha-textfield>\n        <ha-textfield\n          label=\"Target Media Player (optional)\"\n          .value=${this._config.target_media_player || \"\"}\n          .configValue=${\"target_media_player\"}\n          helper=\"Entity ID e.g. media_player.living_room_speaker\"\n          @input=${this._valueChanged}\n        ></ha-textfield>\n        <div class=\"side-by-side\">\n          <ha-formfield label=\"Auto Start\">\n            <ha-switch .checked=${this._config.auto_start !== false} .configValue=${\"auto_start\"} @change=${this._valueChanged}></ha-switch>\n          </ha-formfield>\n          <ha-formfield label=\"Noise Suppression\">\n            <ha-switch .checked=${this._config.noise_suppression !== false} .configValue=${\"noise_suppression\"} @change=${this._valueChanged}></ha-switch>\n          </ha-formfield>\n        </div>\n        <div class=\"side-by-side\">\n          <ha-formfield label=\"Echo Cancellation\">\n            <ha-switch .checked=${this._config.echo_cancellation !== false} .configValue=${\"echo_cancellation\"} @change=${this._valueChanged}></ha-switch>\n          </ha-formfield>\n          <ha-formfield label=\"Auto Gain Control\">\n            <ha-switch .checked=${this._config.auto_gain_control !== false} .configValue=${\"auto_gain_control\"} @change=${this._valueChanged}></ha-switch>\n          </ha-formfield>\n        </div>\n      </div>\n    `;\n  }\n\n  static styles = css`\n    .card-config {\n      display: flex;\n      flex-direction: column;\n      gap: 16px;\n    }\n    .side-by-side {\n      display: flex;\n      flex-wrap: wrap;\n      gap: 16px;\n    }\n    ha-textfield {\n      width: 100%;\n    }\n    ha-formfield {\n      padding-bottom: 8px;\n    }\n  `;\n}\n","import { LitElement, html, css } from \"lit\";\nimport { customElement, property, state, query } from \"lit/decorators.js\";\nimport { VoiceStreamingCardConfig, HomeAssistant, ConnectionStatus } from \"./types\";\nimport { WebRTCManager } from \"./webrtc-manager\";\nimport { sharedStyles } from \"./styles\";\nimport \"./voice-sending-editor\"; // Static import ensures registration\n\n@customElement(\"voice-sending-card\")\nexport class VoiceSendingCard extends LitElement {\n  @property({ attribute: false }) public hass!: HomeAssistant;\n  @state() private config!: VoiceStreamingCardConfig;\n  @state() private status: ConnectionStatus = \"disconnected\";\n  @state() private errorMessage: string = \"\";\n  @state() private latency: number = 0;\n\n  @query(\"canvas\") private canvas!: HTMLCanvasElement;\n\n  private webrtc: WebRTCManager | null = null;\n  private animationFrame: number | null = null;\n\n  static get styles() {\n    return [\n      sharedStyles,\n      css`\n        /* Add specific styles if needed */\n      `,\n    ];\n  }\n\n  public static async getConfigElement() {\n    return document.createElement(\"voice-sending-card-editor\");\n  }\n\n  public static getStubConfig(): VoiceStreamingCardConfig {\n    return {\n      type: \"custom:voice-sending-card\",\n      title: \"Voice Sender\",\n      auto_start: false,\n      noise_suppression: true,\n      echo_cancellation: true,\n      auto_gain_control: true,\n    };\n  }\n\n  public setConfig(config: VoiceStreamingCardConfig): void {\n    if (!config) {\n      throw new Error(\"Invalid configuration\");\n    }\n    this.config = config;\n\n    // If manager already exists, update its config\n    if (this.webrtc) {\n      this.webrtc.updateConfig({\n        serverUrl: this.config.server_url,\n        noiseSuppression: this.config.noise_suppression,\n        echoCancellation: this.config.echo_cancellation,\n        autoGainControl: this.config.auto_gain_control,\n      });\n    }\n  }\n\n  public getCardSize(): number {\n    return 3;\n  }\n\n  connectedCallback() {\n    super.connectedCallback();\n    if (!this.webrtc) {\n      this.webrtc = new WebRTCManager({\n        serverUrl: this.config?.server_url,\n        noiseSuppression: this.config?.noise_suppression,\n        echoCancellation: this.config?.echo_cancellation,\n        autoGainControl: this.config?.auto_gain_control,\n      });\n    }\n\n    this.webrtc.addEventListener(\"state-changed\", (e: any) => {\n      this.status = e.detail.state;\n      if (e.detail.error) {\n        this.errorMessage = e.detail.error;\n      } else {\n        this.errorMessage = \"\";\n      }\n      this.requestUpdate();\n    });\n\n    this.webrtc.addEventListener(\"audio-data\", (e: any) => {\n      if (e.detail.timestamp) {\n        this.latency = Date.now() - e.detail.timestamp * 1000;\n      }\n    });\n\n    // Check for auto_start. Default to false if not provided.\n    if (this.config?.auto_start === true) {\n      this.toggleSending();\n    }\n  }\n\n  disconnectedCallback() {\n    super.disconnectedCallback();\n    this.stopVisualization();\n    this.webrtc?.stop();\n  }\n\n  private async toggleSending() {\n    if (this.status === \"connected\" || this.status === \"connecting\") {\n      this.webrtc?.stop();\n      this.stopVisualization();\n      await this.manageMediaPlayer(\"stop\");\n    } else {\n      await this.webrtc?.startSending();\n      this.startVisualization();\n      await this.manageMediaPlayer(\"play\");\n    }\n  }\n\n  private async manageMediaPlayer(action: \"play\" | \"stop\") {\n    if (!this.config.target_media_player || !this.hass) return;\n\n    try {\n      if (action === \"play\") {\n        // Construct stream URL - assuming port 8081 is exposed for audio\n        // We use HTTP because many local media players (Sonos, etc) struggle with self-signed HTTPS\n        const streamUrl = `http://${window.location.hostname}:8081/stream/latest.mp3`;\n\n        await this.hass.callService(\"media_player\", \"play_media\", {\n          entity_id: this.config.target_media_player,\n          media_content_id: streamUrl,\n          media_content_type: \"music\",\n        });\n      } else {\n        await this.hass.callService(\"media_player\", \"media_stop\", {\n          entity_id: this.config.target_media_player,\n        });\n      }\n    } catch (e) {\n      console.error(\"Failed to control media player:\", e);\n      this.errorMessage = `Media Player Error: ${(e as Error).message}`;\n    }\n  }\n\n  private startVisualization() {\n    if (!this.canvas || !this.webrtc) return;\n    const ctx = this.canvas.getContext(\"2d\");\n    if (!ctx) return;\n\n    const draw = () => {\n      const analyser = this.webrtc?.getAnalyser();\n      if (!analyser) {\n        this.animationFrame = requestAnimationFrame(draw);\n        return;\n      }\n\n      const bufferLength = analyser.frequencyBinCount;\n      const dataArray = new Uint8Array(bufferLength);\n      analyser.getByteFrequencyData(dataArray);\n\n      ctx.fillStyle = \"rgb(240, 240, 240)\";\n      ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);\n\n      const barWidth = (this.canvas.width / bufferLength) * 2.5;\n      let barHeight;\n      let x = 0;\n\n      for (let i = 0; i < bufferLength; i++) {\n        barHeight = (dataArray[i] / 255) * this.canvas.height;\n        ctx.fillStyle = `rgb(${barHeight + 100}, 50, 50)`;\n        ctx.fillRect(x, this.canvas.height - barHeight / 2, barWidth, barHeight);\n        x += barWidth + 1;\n      }\n\n      this.animationFrame = requestAnimationFrame(draw);\n    };\n\n    draw();\n  }\n\n  private stopVisualization() {\n    if (this.animationFrame) {\n      cancelAnimationFrame(this.animationFrame);\n      this.animationFrame = null;\n    }\n  }\n\n  protected render() {\n    if (!this.config) return html``;\n\n    const isSending = this.status === \"connected\";\n    const buttonIcon = isSending ? \"ðŸ›‘\" : \"ðŸŽ¤\";\n    const statusText = this.errorMessage || this.status;\n\n    return html`\n      <ha-card>\n        <div class=\"header\">\n          <div class=\"title\">${this.config.title || this.config.name || \"Voice Send\"}</div>\n          <div class=\"status-badge ${this.status}\">${this.status}</div>\n        </div>\n\n        <div class=\"content\">\n          <div class=\"visualization\">\n            <canvas width=\"300\" height=\"64\"></canvas>\n          </div>\n\n          <div class=\"controls\">\n            <button\n              class=\"main-button ${isSending ? \"active\" : \"\"} ${this.status === \"error\" ? \"error\" : \"\"}\"\n              @click=${this.toggleSending}\n              ?disabled=${this.status === \"connecting\"}\n            >\n              ${buttonIcon}\n            </button>\n          </div>\n\n          <div class=\"stats\">${isSending ? html`<span>Latency: ${this.latency}ms</span>` : \"\"}</div>\n\n          ${this.errorMessage ? html`<div class=\"error-message\">${this.errorMessage}</div>` : \"\"}\n        </div>\n      </ha-card>\n    `;\n  }\n}\n\n// Register for HACS\n(window as any).customCards = (window as any).customCards || [];\n(window as any).customCards.push({\n  type: \"voice-sending-card\",\n  name: \"Voice Sending Card\",\n  description: \"Send voice audio via WebRTC\",\n  preview: true,\n  editor: \"voice-sending-card-editor\", // Add visual editor support\n});\n"],"names":["VoiceSendingCardEditor","LitElement","setConfig","config","this","_config","_valueChanged","ev","hass","target","configValue","value","newConfig","undefined","checked","dispatchEvent","CustomEvent","detail","bubbles","composed","render","html","title","server_url","target_media_player","auto_start","noise_suppression","echo_cancellation","auto_gain_control","styles","css","__decorate","property","attribute","prototype","state","customElement","VoiceSendingCard","constructor","status","errorMessage","latency","webrtc","animationFrame","sharedStyles","getConfigElement","document","createElement","getStubConfig","type","Error","updateConfig","serverUrl","noiseSuppression","echoCancellation","autoGainControl","getCardSize","connectedCallback","super","WebRTCManager","addEventListener","e","error","requestUpdate","timestamp","Date","now","toggleSending","disconnectedCallback","stopVisualization","stop","manageMediaPlayer","startSending","startVisualization","action","streamUrl","window","location","hostname","callService","entity_id","media_content_id","media_content_type","console","message","canvas","ctx","getContext","draw","analyser","getAnalyser","requestAnimationFrame","bufferLength","frequencyBinCount","dataArray","Uint8Array","getByteFrequencyData","fillStyle","fillRect","width","height","barWidth","barHeight","x","i","cancelAnimationFrame","isSending","buttonIcon","name","query","customCards","push","description","preview","editor"],"mappings":"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"}